<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Mis Auditorias</title>
    <link rel="stylesheet" href="/Proyecto/mis_auditorias.css">
    <script src="/Proyecto/api.js"></script>
</head>
<body>
  <header>
    <div class="logo">El Comit칠</div>
  </header>
  <div class="container">
    <nav class="sidebar">
      <a href="/Proyecto/seccion_iniciada.html">九勇 Planear auditor칤a</a>
      <a href="/Proyecto/mis_auditorias.html">游눹 Mis auditor칤as</a>
      <a href="/Proyecto/tablero.html">游늵 Generar Tablero</a>
    </nav>
    <main>
      <div class="top-bar">
        <h2>Mis auditor칤as</h2>        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Buscar por nombre" onkeyup="filterAudits()" />
        </div>
        <a href="/Proyecto/seccion_iniciada.html"><button class="plan-btn">Planear auditor칤a</button></a>
      </div>

      <table>
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Fecha</th>
      <th>Auditor</th>
      <th></th>
    </tr>
  </thead>  <tbody id="auditsTableBody">
    <!-- Las auditor칤as se cargar치n din치micamente -->
  </tbody>
</table>

    </main>
  </div>

  <script>
    let allAudits = [];

    // Verificar autenticaci칩n al cargar la p치gina
    window.addEventListener('DOMContentLoaded', async () => {
      if (!requireAuth()) {
        return;
      }
      
      await loadAudits();
    });

    // Cargar auditor칤as desde el backend
    async function loadAudits() {
      try {
        console.log('Cargando auditor칤as...');
        const response = await api.audits.getAll();
        console.log('Respuesta del servidor:', response);
        
        if (response.success && response.data) {
          allAudits = response.data;
          displayAudits(response.data);
        } else {
          console.error('Error en la respuesta:', response);
          allAudits = [];
          displayAudits([]);
        }
      } catch (error) {
        console.error('Error al cargar auditor칤as:', error);
        alert('Error al cargar las auditor칤as: ' + error.message);
        allAudits = [];
        displayAudits([]);
      }
    }

    // Mostrar auditor칤as en la tabla
    function displayAudits(audits) {
      const tableBody = document.getElementById('auditsTableBody');
      
      if (!audits || audits.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; color: #666;">
              No hay auditor칤as disponibles
            </td>
          </tr>
        `;
        return;
      }

      tableBody.innerHTML = audits.map(audit => `
        <tr>
          <td>${audit.name || audit.process || 'Sin nombre'}</td>
          <td>${audit.planned_date ? new Date(audit.planned_date).toLocaleDateString('es-ES') : 
                audit.auditDate ? new Date(audit.auditDate).toLocaleDateString('es-ES') : 'Sin fecha'}</td>
          <td>${audit.auditor ? audit.auditor.fullName : 
                audit.User ? audit.User.fullName || audit.User.name : 'N/A'}</td>
          <td>
            <button class="report-btn" onclick="generateReport(${audit.id})">
              Generar Informe
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Filtrar auditor칤as por nombre
    function filterAudits() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filteredAudits = allAudits.filter(audit =>
        audit.name.toLowerCase().includes(searchTerm)
      );
      displayAudits(filteredAudits);
    }

    // Generar informe (placeholder)
    function generateReport(auditId) {
      const audit = allAudits.find(a => a.id === auditId);
      if (audit) {
        alert(`Generando informe para: ${audit.name}`);
        // Aqu칤 se podr칤a redirigir a una p치gina de generaci칩n de informes
        // window.location.href = `generar_informe.html?auditId=${auditId}`;
      }
    }
  </script>
</body>
</html>